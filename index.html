<script>
    /* ---------- CONFIG ---------- */
    const EUR2USD = 1.08; 
    let DATA = JSON.parse(localStorage.getItem('budgetEn')) || [];
    let CUR_DATE = new Date();
    let CHART;

    /* ---------- UTILS ---------- */
    const $ = id => document.getElementById(id);
    const save = () => {
        try {
            localStorage.setItem('budgetEn', JSON.stringify(DATA));
            console.log("Données sauvegardées avec succès.");
        } catch (e) {
            console.error("Erreur lors de la sauvegarde des données :", e);
        }
    };
    const fmt = n => n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    /* ---------- TOTALS ---------- */
    function refreshTotals() {
        try {
            const inc = DATA.filter(t => t.type === 'income').reduce((s, t) => s + t.usd, 0);
            const exp = DATA.filter(t => t.type === 'expense').reduce((s, t) => s + t.usd, 0);
            $('inc').textContent = '$' + fmt(inc);
            $('exp').textContent = '$' + fmt(exp);
            $('sol').textContent = '$' + fmt(inc - exp);
        } catch (e) {
            console.error("Erreur de rafraîchissement des totaux:", e);
        }
    }

    /* ---------- CALENDAR ---------- */
    function buildCalendar() {
        try {
            const y = CUR_DATE.getFullYear(), m = CUR_DATE.getMonth();
            $('mois').textContent = new Date(y, m).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            
            const firstDayOfMonth = new Date(y, m, 1);
            const startDay = new Date(firstDayOfMonth);
            startDay.setDate(startDay.getDate() - (startDay.getDay() === 0 ? 6 : startDay.getDay() - 1)); 

            $('cal').innerHTML = '';

            for (let i = 0; i < 42; i++) {
                const day = new Date(startDay);
                day.setDate(startDay.getDate() + i);

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day.getDate();
                dayDiv.setAttribute('role', 'gridcell');
                dayDiv.setAttribute('aria-label', day.toDateString());

                if (day.getMonth() !== m) {
                    dayDiv.classList.add('other-month');
                }
                if (day.toDateString() === new Date().toDateString()) {
                    dayDiv.classList.add('today');
                }

                const dayTransactions = DATA.filter(t => new Date(t.date).toDateString() === day.toDateString());
                if (dayTransactions.length) {
                    const dotsContainer = document.createElement('div');
                    dotsContainer.className = 'dots';
                    if (dayTransactions.some(t => t.type === 'income')) {
                        const dot = document.createElement('div'); dot.className = 'dot income'; dotsContainer.appendChild(dot);
                    }
                    if (dayTransactions.some(t => t.type === 'expense')) {
                        const dot = document.createElement('div'); dot.className = 'dot expense'; dotsContainer.appendChild(dot);
                    }
                    dayDiv.appendChild(dotsContainer);
                }

                dayDiv.addEventListener('click', () => {
                    $('dat').valueAsDate = day;
                });
                $('cal').appendChild(dayDiv);
            }
        } catch (e) {
            console.error("Erreur de construction du calendrier:", e);
        }
    }

    /* ---------- MONTH LIST ---------- */
    function refreshList() {
        try {
            const y = CUR_DATE.getFullYear(), m = CUR_DATE.getMonth();
            const monthTransactions = DATA.filter(t => {
                const d = new Date(t.date);
                return d.getFullYear() === y && d.getMonth() === m;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));

            $('list').innerHTML = '';

            if (!monthTransactions.length) {
                $('list').innerHTML = '<p style="text-align:center;color:var(--light-text-color); padding: 20px;">Pas de transactions pour ce mois.</p>';
                return;
            }

            monthTransactions.forEach(t => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.setAttribute('role', 'listitem');
                div.innerHTML = `
                    <div class="item-details">
                        <strong>${t.desc}</strong>
                        <small>${t.cat} • ${new Date(t.date).toLocaleDateString('en-US')}</small>
                    </div>
                    <div class="amount-info">
                        <div class="value ${t.type}">${t.amt} ${t.cur}</div>
                        <small>$${fmt(t.usd)}</small>
                    </div>
                    <button class="delete-btn" onclick="delTrans(${t.id})" aria-label="Supprimer la transaction ${t.desc}">×</button>
                `;
                $('list').appendChild(div);
            });
        } catch (e) {
            console.error("Erreur de rafraîchissement de la liste:", e);
        }
    }

    /* ---------- CHART ---------- */
    function refreshChart() {
        try {
            const ctx = $('chart').getContext('2d');
            if (CHART) CHART.destroy();

            const expensesByCategory = DATA.filter(t => t.type === 'expense').reduce((acc, t) => {
                acc[t.cat] = (acc[t.cat] || 0) + t.usd;
                return acc;
            }, {});

            if (!Object.keys(expensesByCategory).length) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            CHART = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expensesByCategory),
                    datasets: [{
                        data: Object.values(expensesByCategory),
                        backgroundColor: ['#4F46E5', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#EF4444', '#0EA5E9', '#EAB308'],
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12,
                                    family: 'Inter'
                                },
                                color: 'var(--text-color)',
                                usePointStyle: true,
                            },
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += '$' + fmt(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        } catch (e) {
            console.error("Erreur de rafraîchissement du graphique:", e);
        }
    }

    /* ---------- DELETE ACTIONS ---------- */
    window.delTrans = id => {
        if (confirm('Êtes-vous sûr de vouloir supprimer cette transaction ?')) {
            DATA = DATA.filter(t => t.id !== id);
            save();
            refreshAll();
        }
    };

    $('delLast').onclick = () => {
        if (!DATA.length) {
            alert('Il n\'y a aucune transaction à supprimer.');
            return;
        }
        if (confirm('Supprimer la dernière transaction ?')) {
            DATA.pop();
            save();
            refreshAll();
        }
    };

    $('delMonth').onclick = () => {
        const y = CUR_DATE.getFullYear(), m = CUR_DATE.getMonth();
        const transactionsToDelete = DATA.filter(t => {
            const d = new Date(t.date);
            return d.getFullYear() === y && d.getMonth() === m;
        });

        if (!transactionsToDelete.length) {
            alert('Aucune transaction trouvée pour le mois en cours.');
            return;
        }
        if (confirm(`Supprimer ${transactionsToDelete.length} transaction(s) de ce mois ?`)) {
            DATA = DATA.filter(t => {
                const d = new Date(t.date);
                return !(d.getFullYear() === y && d.getMonth() === m);
            });
            save();
            refreshAll();
        }
    };

    $('reset').onclick = () => {
        if (confirm('Êtes-vous absolument sûr de vouloir supprimer TOUTES vos données ? Cette action est irréversible.')) {
            if (confirm('Sérieusement ? Toutes les données seront perdues.')) {
                DATA = [];
                save();
                refreshAll();
            }
        }
    };

    /* ---------- FORM SUBMISSION ---------- */
    $('form').addEventListener('submit', e => {
        e.preventDefault();

        const usdAmount = $('cur').value === 'USD' ? parseFloat($('mnt').value) : parseFloat($('mnt').value) * EUR2USD;

        const newTransaction = {
            id: Date.now(),
            desc: $('desc').value,
            amt: parseFloat($('mnt').value),
            cur: $('cur').value,
            type: $('typ').value,
            cat: $('cat').value,
            date: $('dat').value,
            usd: usdAmount
        };

        DATA.push(newTransaction);
        save();
        refreshAll();
        e.target.reset();
        $('dat').valueAsDate = new Date();
    });

    /* ---------- CALENDAR NAVIGATION ---------- */
    $('prev').onclick = () => {
        CUR_DATE.setMonth(CUR_DATE.getMonth() - 1);
        refreshAll();
    };
    $('next').onclick = () => {
        CUR_DATE.setMonth(CUR_DATE.getMonth() + 1);
        refreshAll();
    };

    /* ---------- INITIALIZATION ---------- */
    function refreshAll() {
        try {
            refreshTotals();
            buildCalendar();
            refreshList();
            refreshChart();
        } catch (e) {
            console.error("Erreur critique lors du rafraîchissement de la page:", e);
        }
    }

    // Appel de la fonction de rafraîchissement au chargement de la page
    document.addEventListener('DOMContentLoaded', refreshAll);

    // Initialisation
    refreshAll();
</script>
