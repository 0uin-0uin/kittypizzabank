<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }

        .container {
            max-width: 960px;
            margin: auto;
            padding: 1rem;
        }

        #chartCanvas {
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            width: 100%;
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center">
    <div class="container bg-white p-8 rounded-2xl shadow-xl flex flex-col items-center space-y-6">
        <h1 class="text-4xl font-extrabold text-gray-900 text-center">Financial Dashboard</h1>
        <p class="text-gray-600 text-lg text-center max-w-2xl">
            Welcome to your financial dashboard. This dashboard visualizes your transactions in real-time. The bar chart
            below will update automatically as new data is added to the database.
        </p>

        <div id="status" class="text-sm font-medium text-gray-500">Loading...</div>

        <div class="w-full">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transaction Chart</h2>
            <canvas id="chartCanvas" width="800" height="400" class="w-full"></canvas>
        </div>

        <div class="w-full pt-4">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Instructions</h2>
            <p class="text-gray-600 text-base">To add new transactions, open the console and use the
                <code class="bg-gray-200 px-1 py-0.5 rounded-md font-mono">addTransaction(name, amount)</code>
                function. For example, try:
                <code class="bg-gray-200 px-1 py-0.5 rounded-md font-mono">addTransaction('Groceries', 50)</code>
            </p>
        </div>
    </div>

    <script type="module">
        // Import Firebase libraries.
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            signInWithCustomToken,
            onAuthStateChanged,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            collection,
            onSnapshot,
            addDoc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables provided by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;

        // Set Firestore log level to debug.
        setLogLevel('debug');

        /**
         * Draws a bar chart on the canvas based on transaction data.
         * @param {Array<Object>} transactions - Array of transaction objects.
         */
        const refreshChart = (transactions) => {
            const canvas = document.getElementById('chartCanvas');
            if (!canvas) {
                console.error("Critical error: can't access property 'getContext', canvas is null. Aborting chart refresh.");
                return;
            }

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 50;

            // Clear the canvas for a fresh draw.
            ctx.clearRect(0, 0, width, height);

            // Mock data for display if transactions are empty.
            if (transactions.length === 0) {
                document.getElementById('status').innerText = 'No transactions found. Try adding some!';
                transactions = [{
                    name: 'Placeholder',
                    amount: 100
                }];
            }

            const total = transactions.reduce((sum, t) => sum + t.amount, 0);

            // Find the maximum amount for scaling the bars.
            const maxAmount = transactions.reduce((max, t) => Math.max(max, t.amount), 0);
            const scale = (height - 2 * padding) / maxAmount;

            const barWidth = (width - 2 * padding) / transactions.length * 0.8;
            const barSpacing = (width - 2 * padding) / transactions.length * 0.2;

            ctx.fillStyle = '#6b7280';
            ctx.font = '14px Inter';
            ctx.textAlign = 'center';

            transactions.forEach((transaction, index) => {
                const barHeight = transaction.amount * scale;
                const x = padding + index * (barWidth + barSpacing);
                const y = height - padding - barHeight;

                // Draw the bar.
                ctx.fillStyle = '#4f46e5';
                ctx.beginPath();
                ctx.roundRect(x, y, barWidth, barHeight, 5);
                ctx.fill();

                // Draw the value text.
                ctx.fillStyle = '#4b5563';
                ctx.fillText(`$${transaction.amount}`, x + barWidth / 2, y - 10);

                // Draw the name text.
                ctx.fillText(transaction.name, x + barWidth / 2, height - padding + 20);
            });
        };

        /**
         * Adds a new transaction document to the Firestore database.
         * This function is made available on the window object for easy access from the console.
         * @param {string} name - The name of the transaction.
         * @param {number} amount - The amount of the transaction.
         */
        window.addTransaction = async (name, amount) => {
            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return;
            }

            const transactionsPath = `artifacts/${appId}/public/data/transactions`;
            const transactionsRef = collection(db, transactionsPath);

            try {
                await addDoc(transactionsRef, {
                    name: name,
                    amount: amount,
                    timestamp: new Date()
                });
                console.log(`Transaction added: ${name} - $${amount}`);
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        };

        /**
         * Initializes Firebase and sets up the Firestore listener.
         */
        const initFirebaseAndListen = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user using the custom token or anonymously.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for the authentication state to be ready.
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('status').innerText = `User ID: ${userId}`;
                        console.log(`User ID: ${userId}`);
                        
                        // Set up the real-time listener for the transactions collection.
                        const transactionsPath = `artifacts/${appId}/public/data/transactions`;
                        const transactionsRef = collection(db, transactionsPath);
                        
                        onSnapshot(transactionsRef, (snapshot) => {
                            const transactions = [];
                            snapshot.forEach((doc) => {
                                transactions.push(doc.data());
                            });
                            console.log("Transactions data updated. Total transactions:", transactions.length);
                            // Call the chart refresh function with the new data.
                            refreshChart(transactions);
                        }, (error) => {
                            console.error("Error listening to transactions: ", error);
                        });
                    } else {
                        console.log("No user signed in.");
                        document.getElementById('status').innerText = 'Signed out';
                    }
                });

            } catch (e) {
                console.error("Error initializing Firebase:", e);
                document.getElementById('status').innerText = 'Error loading data.';
            }
        };

        // The fix: wait for the window to load before initializing Firebase and accessing the canvas.
        window.onload = function() {
            initFirebaseAndListen();
        };
    </script>
</body>

</html>
