<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget + Calendrier (Corrig√©)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-box {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            color: white;
        }

        .summary-box.income { background: #10b981; }
        .summary-box.expense { background: #ef4444; }
        .summary-box.balance { background: #6366f1; }

        .summary-box h3 { font-size: 0.875rem; opacity: 0.9; }
        .summary-box .amount { font-size: 1.5rem; font-weight: bold; }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover { background: #4f46e5; }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .calendar-header div {
            text-align: center;
            font-weight: bold;
            font-size: 0.875rem;
            color: #666;
            padding: 10px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 0.875rem;
        }

        .calendar-day:hover { background: #f3f4f6; }
        .calendar-day.today { background: #6366f1; color: white; font-weight: bold; }
        .calendar-day.other-month { color: #d1d5db; }
        
        .calendar-day.has-income::after { 
            content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; 
            background: #10b981; border-radius: 50%; 
        }
        .calendar-day.has-expense::after { 
            content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; 
            background: #ef4444; border-radius: 50%; 
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        .transaction-item:last-child { border-bottom: none; }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .transaction-item:hover .delete-btn { opacity: 1; }

        .transaction-amount.income { color: #10b981; }
        .transaction-amount.expense { color: #ef4444; }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .month-nav button {
            width: auto;
            padding: 8px 16px;
            background: #e5e7eb;
            color: #374151;
        }

        .month-nav button:hover { background: #d1d5db; }

        .month-display {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .delete-zone {
            margin-top: 20px;
            padding: 15px;
            background: #fef2f2;
            border-radius: 8px;
            border: 2px dashed #fecaca;
        }

        .delete-zone h3 {
            color: #dc2626;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .delete-actions {
            display: flex;
            gap: 10px;
        }

        .delete-actions button {
            background: #ef4444;
            font-size: 0.875rem;
            padding: 8px 12px;
        }

        .delete-actions button:hover { background: #dc2626; }

        .chart-container {
            height: 200px;
            margin-top: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* CORRECTION : Conteneur pour les points du calendrier */
        .calendar-dots {
            position: absolute;
            bottom: 2px;
            display: flex;
            gap: 2px;
        }

        .calendar-dot {
            width: 3px;
            height: 3px;
            border-radius: 50%;
        }

        .calendar-dot.income { background: #10b981; }
        .calendar-dot.expense { background: #ef4444; }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .summary { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 style="text-align: center; margin-bottom: 20px;">üí∞ Budget + Calendrier</h1>
            
            <div class="summary">
                <div class="summary-box income">
                    <h3>Revenus</h3>
                    <div class="amount" id="totalIncome">$0.00</div>
                </div>
                <div class="summary-box expense">
                    <h3>D√©penses</h3>
                    <div class="amount" id="totalExpense">$0.00</div>
                </div>
                <div class="summary-box balance">
                    <h3>Solde</h3>
                    <div class="amount" id="balance">$0.00</div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Ajouter une transaction</h2>
                <form id="transactionForm" class="form-grid">
                    <input type="text" id="description" placeholder="Description" required>
                    <input type="number" id="amount" step="0.01" placeholder="Montant" required>
                    
                    <select id="type" required>
                        <option value="">Type</option>
                        <option value="income">Revenu</option>
                        <option value="expense">D√©pense</option>
                    </select>
                    
                    <select id="currency" required>
                        <option value="">Devise</option>
                        <option value="EUR">EUR</option>
                        <option value="USD">USD</option>
                    </select>
                    
                    <select id="category" required>
                        <option value="">Cat√©gorie</option>
                        <option value="salaire">Salaire</option>
                        <option value="alimentation">Alimentation</option>
                        <option value="logement">Logement</option>
                        <option value="transport">Transport</option>
                        <option value="autre">Autre</option>
                    </select>
                    
                    <input type="date" id="date" required>
                    
                    <button type="submit" style="grid-column: 1 / -1;">Ajouter</button>
                </form>
            </div>

            <div class="card">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">‚Äπ</button>
                    <div class="month-display" id="currentMonth"></div>
                    <button onclick="changeMonth(1)">‚Ä∫</button>
                </div>
                
                <div class="calendar-header">
                    <div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div>
                </div>
                <div class="calendar" id="calendar"></div>
            </div>
        </div>

        <div class="card">
            <h2>Transactions du mois</h2>
            <div id="monthTransactions"></div>
        </div>

        <div class="card">
            <h2>R√©partition des d√©penses</h2>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <div class="card delete-zone">
            <h3>üóëÔ∏è Supprimer des donn√©es</h3>
            <div class="delete-actions">
                <button onclick="deleteLastTransaction()">Supprimer la derni√®re</button>
                <button onclick="deleteAllVisible()">Supprimer ce mois</button>
                <button onclick="resetAll()">Tout r√©initialiser</button>
            </div>
        </div>
    </div>

    <script>
        const EUR_TO_USD_RATE = 1.08;
        let transactions = JSON.parse(localStorage.getItem('budgetTransactions')) || [];
        let currentDate = new Date();
        let chartInstance = null; // CORRECTION : Pour √©viter les erreurs de graphique

        // Initialisation
        document.getElementById('transactionForm').addEventListener('submit', addTransaction);
        document.getElementById('date').valueAsDate = new Date();
        
        updateDisplay();
        renderCalendar();

        function addTransaction(e) {
            e.preventDefault();
            
            const transaction = {
                id: Date.now(),
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                type: document.getElementById('type').value,
                currency: document.getElementById('currency').value,
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
                amountUSD: document.getElementById('currency').value === 'USD' 
                    ? parseFloat(document.getElementById('amount').value) 
                    : parseFloat(document.getElementById('amount').value) * EUR_TO_USD_RATE
            };

            transactions.push(transaction);
            saveTransactions();
            updateDisplay();
            renderCalendar(); // CORRECTION : Actualiser le calendrier
            e.target.reset();
            document.getElementById('date').valueAsDate = new Date();
        }

        function saveTransactions() {
            localStorage.setItem('budgetTransactions', JSON.stringify(transactions));
        }

        function updateDisplay() {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amountUSD, 0);

            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amountUSD, 0);

            const balance = totalIncome - totalExpense;

            document.getElementById('totalIncome').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpense').textContent = `$${totalExpense.toFixed(2)}`;
            document.getElementById('balance').textContent = `$${balance.toFixed(2)}`;
            
            updateMonthTransactions();
            updateChart(); // CORRECTION : Toujours mettre √† jour le graphique
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
            updateMonthTransactions(); // CORRECTION : Actualiser les transactions du mois
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthDisplay = document.getElementById('currentMonth');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            monthDisplay.textContent = new Date(year, month).toLocaleDateString('fr-FR', { 
                year: 'numeric', 
                month: 'long' 
            });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay() + 1);

            calendar.innerHTML = '';

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = date.getDate();
                
                if (date.getMonth() !== month) {
                    dayDiv.classList.add('other-month');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayDiv.classList.add('today');
                }
                
                // CORRECTION : V√©rifier les transactions pour ce jour
                const dayTransactions = transactions.filter(t => 
                    new Date(t.date).toDateString() === date.toDateString()
                );
                
                if (dayTransactions.length > 0) {
                    const dotsContainer = document.createElement('div');
                    dotsContainer.className = 'calendar-dots';
                    
                    if (dayTransactions.some(t => t.type === 'income')) {
                        const incomeDot = document.createElement('div');
                        incomeDot.className = 'calendar-dot income';
                        dotsContainer.appendChild(incomeDot);
                    }
                    if (dayTransactions.some(t => t.type === 'expense')) {
                        const expenseDot = document.createElement('div');
                        expenseDot.className = 'calendar-dot expense';
                        dotsContainer.appendChild(expenseDot);
                    }
                    
                    dayDiv.appendChild(dotsContainer);
                }
                
                dayDiv.addEventListener('click', () => selectDay(date));
                calendar.appendChild(dayDiv);
            }
        }

        function selectDay(date) {
            document.getElementById('date').valueAsDate = date;
        }

        function updateMonthTransactions() {
            const list = document.getElementById('monthTransactions');
            list.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate.getFullYear() === year && 
                       transactionDate.getMonth() === month;
            });

            if (monthTransactions.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">Aucune transaction ce mois-ci</p>';
                return;
            }

            monthTransactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(transaction => {
                    const div = document.createElement('div');
                    div.className = 'transaction-item';
                    div.innerHTML = `
                        <div>
                            <strong>${transaction.description}</strong><br>
                            <small>${transaction.category} ‚Ä¢ ${new Date(transaction.date).toLocaleDateString('fr-FR')}</small>
                        </div>
                        <div style="text-align: right;">
                            <div class="transaction-amount ${transaction.type}">
                                ${transaction.amount} ${transaction.currency}
                            </div>
                            <small>$${transaction.amountUSD.toFixed(2)}</small>
                        </div>
                        <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">√ó</button>
                    `;
                    list.appendChild(div);
                });
        }

        function deleteTransaction(id) {
            if (confirm('Supprimer cette transaction ?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateDisplay();
                renderCalendar(); // CORRECTION : Actualiser le calendrier
            }
        }

        function deleteLastTransaction() {
            if (transactions.length === 0) {
                alert('Aucune transaction √† supprimer');
                return;
            }
            
            if (confirm('Supprimer la derni√®re transaction ?')) {
                transactions.pop();
                saveTransactions();
                updateDisplay();
                renderCalendar(); // CORRECTION : Actualiser le calendrier
            }
        }

        function deleteAllVisible() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthTransactions = transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getFullYear() === year && tDate.getMonth() === month;
            });
            
            if (monthTransactions.length === 0) {
                alert('Aucune transaction ce mois-ci');
                return;
            }
            
            if (confirm(`Supprimer les ${monthTransactions.length} transactions de ce mois ?`)) {
                transactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return !(tDate.getFullYear() === year && tDate.getMonth() === month);
                });
                saveTransactions();
                updateDisplay();
                renderCalendar(); // CORRECTION : Actualiser le calendrier
            }
        }

        function resetAll() {
            if (confirm('‚ö†Ô∏è TOUT supprimer ? Cette action est irr√©versible !')) {
                if (confirm('Derni√®re chance : √™tes-vous VRAIMENT s√ªr ?')) {
                    transactions = [];
                    saveTransactions();
                    updateDisplay();
                    renderCalendar(); // CORRECTION : Actualiser le calendrier
                }
            }
        }

        function updateChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // CORRECTION : D√©truire l'ancien graphique s'il existe
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const expensesByCategory = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amountUSD;
                    return acc;
                }, {});

            // CORRECTION : Ne cr√©er le graphique que s'il y a des donn√©es
            if (Object.keys(expensesByCategory).length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expensesByCategory),
                    datasets: [{
                        data: Object.values(expensesByCategory),
                        backgroundColor: ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    </script>
</body>
</html>
