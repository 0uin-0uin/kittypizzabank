<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Budget ‚Äì tout s‚Äôactualise</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--p:#6366f1;--g:#10b981;--r:#ef4444;--b:#f5f5f5}
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    body{background:var(--b);padding:20px;color:#1f2937}
    .card{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    h1{text-align:center;margin-bottom:20px;font-weight:600;font-size:1.5rem}
    .sum{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .sum div{text-align:center;padding:14px;border-radius:8px;color:#fff;font-weight:600}
    .sum div h3{font-size:.75rem;opacity:.9;font-weight:400}
    .sum .i{background:var(--g)}.sum .e{background:var(--r)}.sum .t{background:var(--p)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:1rem}
    button{grid-column:1/-1;padding:10px;background:var(--p);color:#fff;border:none;border-radius:8px;font-size:1rem;cursor:pointer}
    button:hover{background:#4f46e5}
    .cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .cal-nav button{width:auto;padding:6px 12px;background:#e5e7eb;color:#111}
    .cal-head,.cal{ display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center}
    .cal-head{font-size:.75rem;font-weight:600;color:#6b7280;margin-bottom:4px}
    .cal-day{aspect-ratio:1/1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:8px;font-size:.875rem;cursor:pointer;position:relative}
    .cal-day:hover{background:#f3f4f6}
    .cal-day.today{background:var(--p);color:#fff;font-weight:700}
    .cal-day.other{color:#d1d5db}
    .dots{position:absolute;bottom:4px;display:flex;gap:2px}
    .dot{width:3px;height:3px;border-radius:50%}
    .dot.i{background:var(--g)}.dot.e{background:var(--r)}
    .list{max-height:280px;overflow-y:auto}
    .item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee}
    .item:last-child{border-bottom:none}
    .item:hover .del{opacity:1}
    .del{background:var(--r);color:#fff;border:none;width:20px;height:20px;border-radius:50%;cursor:pointer;font-size:14px;line-height:1;opacity:0;transition:.2s}
    .amt.income{color:var(--g)}.amt.expense{color:var(--r)}
    .del-zone{background:#fef2f2;border:1px dashed #fca5a5;border-radius:8px;padding:12px;text-align:center}
    .del-zone h4{color:#b91c1c;margin-bottom:8px;font-size:.9rem}
    .del-actions{display:flex;gap:8px}
    .del-actions button{background:var(--r);font-size:.8rem;padding:6px}
    .del-actions button:hover{background:#dc2626}
    .chart-container{height:200px;margin-top:10px}
    @media(max-width:700px){.grid{grid-template-columns:1fr}.sum{grid-template-columns:1fr}}
  </style>
</head>
<body>

<div class="container">
  <!-- SOLDES -->
  <div class="card">
    <h1>üí∞ Budget en temps r√©el</h1>
    <div class="sum">
      <div class="i"><h3>Revenus</h3><span id="inc">$0.00</span></div>
      <div class="e"><h3>D√©penses</h3><span id="exp">$0.00</span></div>
      <div class="t"><h3>Solde</h3><span id="sol">$0.00</span></div>
    </div>
  </div>

  <!-- FORM + CALENDRIER -->
  <div class="grid">
    <div class="card">
      <h2>Ajouter une transaction</h2>
      <form id="form">
        <input id="desc" type="text" placeholder="Description" required>
        <input id="mnt" type="number" step="0.01" placeholder="Montant" required>
        <select id="typ" required><option value="">Type</option><option value="income">Revenu</option><option value="expense">D√©pense</option></select>
        <select id="cur" required><option value="">Devise</option><option value="EUR">EUR</option><option value="USD">USD</option></select>
        <select id="cat" required><option value="">Cat√©gorie</option><option value="salaire">Salaire</option><option value="alimentation">Alimentation</option><option value="logement">Logement</option><option value="transport">Transport</option><option value="autre">Autre</option></select>
        <input id="dat" type="date" required>
        <button type="submit">Ajouter</button>
      </form>
    </div>

    <div class="card">
      <div class="cal-nav">
        <button id="prev">‚Äπ</button><div id="mois"></div><button id="next">‚Ä∫</button>
      </div>
      <div class="cal-head"><div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div></div>
      <div id="cal" class="cal"></div>
    </div>
  </div>

  <!-- LISTE + GRAPHIQUE -->
  <div class="grid">
    <div class="card"><h2>Transactions du mois</h2><div id="list" class="list"></div></div>
    <div class="card">
      <h2>R√©partition des d√©penses</h2>
      <div class="chart-container"><canvas id="chart"></canvas></div>
    </div>
  </div>

  <!-- SUPPRESSIONS -->
  <div class="card del-zone">
    <h4>üóëÔ∏è Supprimer des donn√©es</h4>
    <div class="del-actions">
      <button id="delLast">Suppr. derni√®re</button>
      <button id="delMonth">Suppr. ce mois</button>
      <button id="reset">Tout r√©initialiser</button>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const EUR2USD = 1.08;
let DATA = JSON.parse(localStorage.getItem('budget'))||[];
let CUR_DATE = new Date();
let CHART;

/* ---------- UTILS ---------- */
const $ = id => document.getElementById(id);
const save = () => localStorage.setItem('budget',JSON.stringify(DATA));
const fmt = n => n.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2});

/* ---------- AFFICHAGE TOTAL ---------- */
function refreshTotals(){
  const inc = DATA.filter(t=>t.type==='income').reduce((s,t)=>s+t.usd,0);
  const exp = DATA.filter(t=>t.type==='expense').reduce((s,t)=>s+t.usd,0);
  $('inc').textContent = '$'+fmt(inc);
  $('exp').textContent = '$'+fmt(exp);
  $('sol').textContent = '$'+fmt(inc-exp);
}

/* ---------- CALENDRIER ---------- */
function buildCalendar(){
  const y = CUR_DATE.getFullYear(), m = CUR_DATE.getMonth();
  $('mois').textContent = new Date(y,m).toLocaleDateString('fr-FR',{year:'numeric',month:'long'});
  const first = new Date(y,m,1), last = new Date(y,m+1,0);
  const start = new Date(first); start.setDate(start.getDate()-first.getDay()+1);
  $('cal').innerHTML='';
  for(let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const dayDiv = document.createElement('div'); dayDiv.className='cal-day'; dayDiv.textContent=d.getDate();
    if(d.getMonth()!==m) dayDiv.classList.add('other');
    if(d.toDateString()===new Date().toDateString()) dayDiv.classList.add('today');
    // dots
    const dayTrans = DATA.filter(t=>new Date(t.date).toDateString()===d.toDateString());
    if(dayTrans.length){
      const dots=document.createElement('div'); dots.className='dots';
      if(dayTrans.some(t=>t.type==='income')){const dot=document.createElement('div');dot.className='dot i';dots.appendChild(dot);}
      if(dayTrans.some(t=>t.type==='expense')){const dot=document.createElement('div');dot.className='dot e';dots.appendChild(dot);}
      dayDiv.appendChild(dots);
    }
    dayDiv.addEventListener('click',()=>{$('dat').valueAsDate=d;});
    $('cal').appendChild(dayDiv);
  }
}

/* ---------- LISTE MOIS ---------- */
function refreshList(){
  const y=CUR_DATE.getFullYear(),m=CUR_DATE.getMonth();
  const monthTrans=DATA.filter(t=>{const d=new Date(t.date);return d.getFullYear()===y&&d.getMonth()===m;}).sort((a,b)=>new Date(b.date)-new Date(a.date));
  $('list').innerHTML='';
  if(!monthTrans.length){$('list').innerHTML='<p style="text-align:center;color:#9ca3af">Aucune transaction ce mois-ci</p>';return;}
  monthTrans.forEach(t=>{
    const div=document.createElement('div');div.className='item';
    div.innerHTML=`
      <div><strong>${t.desc}</strong><br><small>${t.cat} ‚Ä¢ ${new Date(t.date).toLocaleDateString('fr-FR')}</small></div>
      <div style="text-align:right"><div class="amt ${t.type}">${t.amt} ${t.cur}</div><small>$${fmt(t.usd)}</small></div>
      <button class="del" onclick="delTrans(${t.id})">√ó</button>`;
    $('list').appendChild(div);
  });
}

/* ---------- GRAPHIQUE ---------- */
function refreshChart(){
  const ctx=$('chart').getContext('2d');
  if(CHART) CHART.destroy();
  const exp=DATA.filter(t=>t.type==='expense').reduce((a,t)=>{a[t.cat]=(a[t.cat]||0)+t.usd;return a;},{});
  if(!Object.keys(exp).length){ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);return;}
  CHART=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(exp),datasets:[{data:Object.values(exp),backgroundColor:['#6366f1','#8b5cf6','#ec4899','#f59e0b','#10b981']}]},options:{responsive:true,maintainAspectRatio:false}});
}

/* ---------- SUPPRESSIONS ---------- */
window.delTrans=id=>{if(confirm('Supprimer cette transaction ?')){DATA=DATA.filter(t=>t.id!==id);save();refreshAll();}};
$('delLast').onclick=()=>{if(!DATA.length){alert('Aucune transaction');return;}if(confirm('Supprimer la derni√®re ?')){DATA.pop();save();refreshAll();}};
$('delMonth').onclick=()=>{
  const y=CUR_DATE.getFullYear(),m=CUR_DATE.getMonth();
  const toDel=DATA.filter(t=>{const d=new Date(t.date);return d.getFullYear()===y&&d.getMonth()===m;});
  if(!toDel.length){alert('Ce mois est vide.');return;}
  if(confirm(`Supprimer ${toDel.length} transaction(s) de ce mois ?`)){DATA=DATA.filter(t=>!toDel.includes(t));save();refreshAll();}
};
$('reset').onclick=()=>{if(confirm('Tout supprimer ?')){if(confirm('Vraiment tout ?')){DATA=[];save();refreshAll();}}};

/* ---------- FORMULAIRE ---------- */
$('form').addEventListener('submit',e=>{
  e.preventDefault();
  const usd=$('cur').value==='USD'?+$('mnt').value:+($('mnt').value*EUR2USD);
  DATA.push({id:Date.now(),desc:$('desc').value,amt:+ $('mnt').value,cur:$('cur').value,typ:$('typ').value,cat:$('cat').value,date:$('dat').value,usd});
  save();refreshAll();
  e.target.reset();
  $('dat').valueAsDate=new Date();
});

/* ---------- NAVIGATION CALENDRIER ---------- */
$('prev').onclick=()=>{CUR_DATE.setMonth(CUR_DATE.getMonth()-1);refreshAll();};
$('next').onclick=()=>{CUR_DATE.setMonth(CUR_DATE.getMonth()+1);refreshAll();};

/* ---------- RAFRA√éCHIR TOUT ---------- */
function refreshAll(){
  refreshTotals();
  buildCalendar();
  refreshList();
  refreshChart();
}
refreshAll();
</script>
</body>
</html>
