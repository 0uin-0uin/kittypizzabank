<script>
    /* ---------- CONFIG ---------- */
    // Taux de conversion pour l'exemple
    const EUR2USD = 1.08; 
    // Chargement initial des données depuis le localStorage ou initialisation d'un tableau vide
    let DATA = JSON.parse(localStorage.getItem('budgetEn')) || [];
    // Date courante pour le calendrier
    let CUR_DATE = new Date();
    // Variable pour l'instance du graphique Chart.js
    let CHART;

    /* ---------- UTILS ---------- */
    // Fonction utilitaire pour simplifier l'accès aux éléments par leur ID
    const $ = id => document.getElementById(id);
    // Fonction pour sauvegarder les données dans le localStorage
    const save = () => {
        try {
            localStorage.setItem('budgetEn', JSON.stringify(DATA));
            console.log("Données sauvegardées avec succès.");
        } catch (e) {
            console.error("Erreur lors de la sauvegarde des données :", e);
            alert("Erreur: Les données n'ont pas pu être sauvegardées. Vérifiez la console pour plus de détails.");
        }
    };
    // Fonction pour formater un nombre en devise
    const fmt = n => n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    /* ---------- TOTALS ---------- */
    function refreshTotals(){
        const inc = DATA.filter(t => t.type === 'income').reduce((s, t) => s + t.usd, 0);
        const exp = DATA.filter(t => t.type === 'expense').reduce((s, t) => s + t.usd, 0);
        $('inc').textContent = '$' + fmt(inc);
        $('exp').textContent = '$' + fmt(exp);
        $('sol').textContent = '$' + fmt(inc - exp);
    }

    /* ---------- CALENDAR ---------- */
    function buildCalendar(){
        const y = CUR_DATE.getFullYear(), m = CUR_DATE.getMonth();
        $('mois').textContent = new Date(y, m).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        
        const firstDayOfMonth = new Date(y, m, 1);
        const startDay = new Date(firstDayOfMonth);
        startDay.setDate(startDay.getDate() - (startDay.getDay() === 0 ? 6 : startDay.getDay() - 1)); 

        $('cal').innerHTML = '';

        for (let i = 0; i < 42; i++) {
            const day = new Date(startDay);
            day.setDate(startDay.getDate() + i);

            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = day.getDate();
            dayDiv.setAttribute('role', 'gridcell');
            dayDiv.setAttribute('aria-label', day.toDateString());

            if (day.getMonth() !== m) {
                dayDiv.classList.add('other-month');
            }
            if (day.toDateString() === new Date().toDateString()) {
                dayDiv.classList.add('today');
            }

            const dayTransactions = DATA.filter(t => new Date(t.date).toDateString() === day.toDateString());
            if (dayTransactions.length) {
                const dotsContainer = document.createElement('div');
                dotsContainer.className = 'dots';
                if (dayTransactions.some(t => t.type === 'income')) {
                    const dot = document.createElement('div'); dot.className = 'dot income'; dotsContainer.appendChild(dot);
                }
                if (dayTransactions.some(t => t.type === 'expense')) {
                    const dot = document.createElement('div'); dot.className = 'dot expense'; dotsContainer.appendChild(dot);
                }
                dayDiv.appendChild(dotsContainer);
            }

            dayDiv.addEventListener('click', () => {
                $('dat').valueAsDate = day;
            });
            $('cal').appendChild(dayDiv);
        }
    }

    /* ---------- MONTH LIST ---------- */
    function refreshList(){
        const y = CUR_DATE.getFullYear(), m = CUR_DATE.getMonth();
        const monthTransactions = DATA.filter(t => {
            const d = new Date(t.date);
            return d.getFullYear() === y && d.getMonth() === m;
        }).sort((a, b) => new Date(b.date) - new Date(a.date));

        $('list').innerHTML = '';

        if (!monthTransactions.length) {
            $('list').innerHTML = '<p style="text-align:center;color:var(--light-text-color); padding: 20px;">No transactions for this month.</p>';
            return;
        }

        monthTransactions.forEach(t => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.setAttribute('role', 'listitem');
            div.innerHTML = `
                <div class="item-details">
                    <strong>${t.desc}</strong>
                    <small>${t.cat} • ${new Date(t.date).toLocaleDateString('en-US')}</small>
                </div>
                <div class="amount-info">
                    <div class="value ${t.type}">${t.amt} ${t.cur}</div>
                    <small>$${fmt(t.usd)}</small>
                </div>
                <button class="delete-btn" onclick="delTrans(${t.id})" aria-label="Delete transaction ${t.desc}">×</button>
            `;
            $('list').appendChild(div);
        });
    }

    /* ---------- CHART ---------- */
    function refreshChart(){
        const ctx = $('chart').getContext('2d');
        if (CHART) CHART.destroy();

        const expensesByCategory = DATA.filter(t => t.type === 'expense').reduce((acc, t) => {
            acc[t.cat] = (acc[t.cat] || 0) + t.usd;
            return acc;
        }, {});

        if (!Object.keys(expensesByCategory).length) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            return;
        }

        CHART = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(expensesByCategory),
                datasets: [{
                    data: Object.values(expensesByCategory),
                    backgroundColor: ['#4F46E5', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#EF4444', '#0EA5E9', '#EAB308'],
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                size: 12,
                                family: 'Inter'
                            },
                            color: 'var(--text-color)',
                            usePointStyle: true,
                        },
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += '$' + fmt(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    /* ---------- DELETE ACTIONS ---------- */
    window.delTrans = id => {
        if (confirm('Are you sure you want to delete this transaction?')) {
            DATA = DATA.filter(t => t.id !== id);
            save();
            refreshAll();
        }
    };

    $('delLast').onclick = () => {
        if (!DATA.length) {
            alert('There are no transactions to delete.');
            return;
        }
        if (confirm('Delete the last transaction?')) {
            DATA.pop();
            save();
            refreshAll();
        }
    };

    $('delMonth').onclick = () => {
        const y = CUR_DATE.getFullYear(), m = CUR_DATE.getMonth();
        const transactionsToDelete = DATA.filter(t => {
            const d = new Date(t.date);
            return d.getFullYear() === y && d.getMonth() === m;
        });

        if (!transactionsToDelete.length) {
            alert('No transactions found for the current month.');
            return;
        }
        if (confirm(`Delete ${transactionsToDelete.length} transaction(s) from this month?`)) {
            DATA = DATA.filter(t => {
                const d = new Date(t.date);
                return !(d.getFullYear() === y && d.getMonth() === m);
            });
            save();
            refreshAll();
        }
    };

    $('reset').onclick = () => {
        if (confirm('Are you absolutely sure you want to delete ALL your budget data? This action cannot be undone.')) {
            if (confirm('Seriously? All data will be lost.')) {
                DATA = [];
                save();
                refreshAll();
            }
        }
    };

    /* ---------- FORM SUBMISSION ---------- */
    $('form').addEventListener('submit', e => {
        e.preventDefault();

        const usdAmount = $('cur').value === 'USD' ? parseFloat($('mnt').value) : parseFloat($('mnt').value) * EUR2USD;

        const newTransaction = {
            id: Date.now(),
            desc: $('desc').value,
            amt: parseFloat($('mnt').value),
            cur: $('cur').value,
            type: $('typ').value,
            cat: $('cat').value,
            date: $('dat').value,
            usd: usdAmount
        };

        // Ajout de la nouvelle transaction au tableau
        DATA.push(newTransaction);
        
        // Sauvegarde immédiate
        save();
        
        // Mise à jour de l'interface graphique
        refreshAll();
        
        // Réinitialisation du formulaire
        e.target.reset();
        $('dat').valueAsDate = new Date();
        
        console.log("Nouvelle transaction ajoutée :", newTransaction);
        console.log("État actuel du tableau DATA :", DATA);
    });

    /* ---------- CALENDAR NAVIGATION ---------- */
    $('prev').onclick = () => {
        CUR_DATE.setMonth(CUR_DATE.getMonth() - 1);
        refreshAll();
    };
    $('next').onclick = () => {
        CUR_DATE.setMonth(CUR_DATE.getMonth() + 1);
        refreshAll();
    };

    /* ---------- INITIALISATION ---------- */
    function refreshAll(){
        refreshTotals();
        buildCalendar();
        refreshList();
        refreshChart();
    }

    refreshAll();
</script>
